<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××™ ×”××¡×ª×•×¨×™×Ÿ - ×”×¨×¤×ª×§×ª ×—×©×‘×•×Ÿ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@700&family=Rubik+Wet+Paint&family=Suez+One&display=swap" rel="stylesheet">

    <style>
        :root {
            --wood-dark: #5D4037;
            --wood-light: #8D6E63;
            --gold: #FFD700;
            --gold-shadow: #B8860B;
            --paper-bg: #F5E6C8;
            --ocean: #4facfe;
            --ocean-deep: #00f2fe;
            --danger: #ff5252;
            --success: #69f0ae;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Suez One', sans-serif;
            background: linear-gradient(180deg, var(--ocean) 0%, var(--ocean-deep) 100%);
            height: 100vh;
            overflow: hidden;
            color: var(--wood-dark);
        }

        /* --- UI Components --- */
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Header / HUD */
        header {
            background: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" fill="%235D4037" rx="10"/></svg>'); 
            background-size: cover;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            color: white;
            z-index: 10;
        }

        .hud-item {
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 2px solid var(--gold);
        }

        .btn-icon {
            background: var(--gold);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 0 var(--gold-shadow);
            transition: transform 0.1s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .btn-icon:active { transform: translateY(4px); box-shadow: none; }

        /* Map Area */
        #map-area {
            flex: 1;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255,255,255,0.2) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255,255,255,0.2) 0%, transparent 20%);
        }

        /* Path (SVG) */
        #path-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2000px; /* Long map */
            z-index: 1;
            pointer-events: none;
        }

        .path-line {
            fill: none;
            stroke: rgba(255, 255, 255, 0.4);
            stroke-width: 8;
            stroke-dasharray: 20, 15;
            stroke-linecap: round;
        }

        /* Islands */
        .island {
            position: absolute;
            width: 100px;
            height: 100px;
            background: var(--paper-bg);
            border-radius: 50%;
            border: 4px solid var(--wood-dark);
            z-index: 2;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            left: 50%; /* Centered horizontally logic handled in JS */
        }
        .island.locked { filter: grayscale(1); opacity: 0.7; cursor: not-allowed; }
        .island.completed { border-color: var(--success); }
        .island.current { animation: float 3s infinite ease-in-out; border-color: var(--gold); transform: scale(1.1); }
        
        .island-num { font-family: 'Rubik Wet Paint', cursive; font-size: 2rem; color: var(--wood-dark); }
        .island-stars { font-size: 0.8rem; color: var(--gold); margin-top: -5px; }

        @keyframes float {
            0%, 100% { transform: scale(1.1) translateY(0); }
            50% { transform: scale(1.1) translateY(-10px); }
        }

        /* Player Character on Map */
        #player-marker {
            position: absolute;
            width: 60px;
            height: 60px;
            z-index: 3;
            transition: all 0.5s ease-in-out;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
        }
        #player-marker img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid white;
            object-fit: cover;
            object-position: top center;
            background: #fff;
        }

        /* --- Modals (Popups) --- */
        .modal {
            position: fixed;
            top: 0; right: 0; bottom: 0; left: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal.active { opacity: 1; pointer-events: all; }

        .paper-modal {
            background: var(--paper-bg);
            width: 90%;
            max-width: 500px;
            padding: 30px;
            border-radius: 10px;
            border: 8px solid var(--wood-dark);
            box-shadow: inset 0 0 40px rgba(93, 64, 55, 0.3);
            text-align: center;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: -20px;
            left: -20px;
            background: var(--danger);
            color: white;
            border: 4px solid white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Shop Grid */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            max-height: 60vh;
            overflow-y: auto;
            margin-top: 20px;
        }

        .shop-item {
            background: rgba(255,255,255,0.5);
            border: 2px solid var(--wood-light);
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: 0.2s;
        }
        .shop-item.selected { border-color: var(--success); background: rgba(105, 240, 174, 0.2); }
        .shop-item img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            object-position: top center; /* ×—×©×•×‘ ×¢×‘×•×¨ ×œ×™×” */
            border: 2px solid rgba(0,0,0,0.1);
        }
        .shop-btn {
            background: var(--success);
            color: var(--wood-dark);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 5px;
            width: 100%;
        }
        .shop-btn:disabled { background: #ccc; }

        /* Math Challenge */
        .math-problem { font-size: 4rem; font-family: 'Rubik Wet Paint', cursive; margin: 20px 0; }
        .answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .answer-btn {
            background: var(--wood-light);
            color: white;
            border: none;
            padding: 20px;
            font-size: 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Suez One', sans-serif;
            box-shadow: 0 4px 0 var(--wood-dark);
        }
        .answer-btn:active { transform: translateY(4px); box-shadow: none; }
        
        /* Feedback */
        .feedback-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 8rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
    </style>
</head>
<body>

<div id="game-container">
    <header>
        <div class="hud-item" id="level-display">ğŸï¸ ×©×œ×‘: 1</div>
        <div class="hud-item" id="coins-display">ğŸ’° 0</div>
        <button class="btn-icon" onclick="game.openShop()">ğŸ›ï¸</button>
    </header>

    <div id="map-area">
        <svg id="path-svg"><path id="path-curve" class="path-line" d=""/></svg>
        <div id="islands-container"></div>
        <div id="player-marker">
            <img src="" id="player-img" alt="×©×—×§×Ÿ">
        </div>
    </div>
</div>

<div class="modal" id="shop-modal">
    <div class="paper-modal">
        <button class="close-btn" onclick="game.closeModal('shop-modal')">X</button>
        <h2 style="font-family: 'Rubik Wet Paint'; font-size: 2.5rem; margin:0;">×—× ×•×ª ×”×¤×™×¨××˜×™×</h2>
        <p>×‘×—×¨ ××ª ×”×“××•×ª ×©×œ×š!</p>
        <div class="shop-grid" id="shop-items"></div>
    </div>
</div>

<div class="modal" id="math-modal">
    <div class="paper-modal">
        <button class="close-btn" onclick="game.closeModal('math-modal')">X</button>
        <h3>×¤×ª×•×¨ ×›×“×™ ×œ×”×ª×§×“×!</h3>
        <div class="math-problem" id="math-problem-text">2 + 2 = ?</div>
        <div class="answers-grid" id="math-answers"></div>
    </div>
</div>

<div class="feedback-overlay" id="feedback">â­</div>

<script>
/**
 * --- ×§×•× ×¤×™×’×•×¨×¦×™×” ×•× ×ª×•× ×™× ---
 */

// ×¨×©×™××ª ×”×“××•×™×•×ª - ×›×•×œ×œ ×œ×™×” ×”×—×“×©×”
const CHARACTERS = [
    {
        id: 'lia',
        name: '×œ×™×”',
        price: 0, // ×“××•×ª ×—×™× ××™×ª
        desc: '×—×•×§×¨×ª ×˜×‘×¢ ×××™×¦×”',
        src: 'lia_p.jpg' // ×©× ×”×§×•×‘×¥ ×©×‘×™×§×©×ª
    },
    {
        id: 'pirate_capt',
        name: '×§×¤×˜×Ÿ ×‘×¨×‘×¨×•×¡×”',
        price: 0, // ×“××•×ª ×‘×¨×™×¨×ª ××—×“×œ
        desc: '××¤×§×“ ×”×¡×¤×™× ×”',
        src: 'https://cdn-icons-png.flaticon.com/512/1999/1999183.png' // Placeholder
    },
    {
        id: 'pirate_girl',
        name: '×”×¤×™×¨××˜×™×ª × ×•×¢×”',
        price: 150,
        desc: '××•××—×™×ª ×œ× ×™×•×•×˜',
        src: 'https://cdn-icons-png.flaticon.com/512/4600/4600676.png' // Placeholder
    },
    {
        id: 'skeleton',
        name: '×©×œ×“×™',
        price: 300,
        desc: '×©×•××¨ ×”××•×¦×¨',
        src: 'https://cdn-icons-png.flaticon.com/512/3220/3220712.png' // Placeholder
    }
];

// ×™×¦×™×¨×ª ×©×œ×‘×™× ××•×˜×•××˜×™×ª (50 ×©×œ×‘×™×)
const LEVELS = Array.from({length: 50}, (_, i) => ({
    id: i + 1,
    difficulty: Math.floor(i / 5) + 1, // ×“×¨×’×ª ×§×•×©×™ ×¢×•×œ×” ×›×œ 5 ×©×œ×‘×™×
    type: (i + 1) % 5 === 0 ? 'boss' : 'normal'
}));

/**
 * --- ×× ×•×¢ ×”×¡××•× ×“ (AudioContext) ---
 * ×œ× ×¦×¨×™×š ×§×‘×¦×™× ×—×™×¦×•× ×™×™×, ××™×™×¦×¨ ×¦×œ×™×œ×™× ×‘×§×•×“
 */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const Sound = {
    playTone: (freq, type, duration) => {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    },
    correct: () => {
        Sound.playTone(600, 'sine', 0.1);
        setTimeout(() => Sound.playTone(800, 'sine', 0.2), 100);
    },
    wrong: () => Sound.playTone(150, 'sawtooth', 0.4),
    click: () => Sound.playTone(400, 'triangle', 0.05),
    win: () => {
        [400, 500, 600, 800].forEach((f, i) => setTimeout(() => Sound.playTone(f, 'square', 0.1), i*100));
    }
};

/**
 * --- ×× ×•×¢ ××ª××˜×™×§×” ---
 */
const MathGen = {
    generate: (level) => {
        const difficulty = Math.min(Math.ceil(level / 5), 6);
        let n1, n2, op, ans;

        switch(difficulty) {
            case 1: // ×—×™×‘×•×¨ ×¢×“ 10
                n1 = Math.floor(Math.random() * 6);
                n2 = Math.floor(Math.random() * 5);
                op = '+';
                break;
            case 2: // ×—×™×‘×•×¨ ×¢×“ 20
                n1 = Math.floor(Math.random() * 11);
                n2 = Math.floor(Math.random() * 10);
                op = '+';
                break;
            case 3: // ×—×™×¡×•×¨ ×¤×©×•×˜
                n1 = Math.floor(Math.random() * 10) + 5;
                n2 = Math.floor(Math.random() * 5);
                op = '-';
                break;
            case 4: // ×›×¤×œ ×‘×¡×™×¡×™ (1-5)
                n1 = Math.floor(Math.random() * 5) + 1;
                n2 = Math.floor(Math.random() * 5) + 1;
                op = 'Ã—';
                break;
            default: // ××ª×’×¨
                n1 = Math.floor(Math.random() * 10) + 2;
                n2 = Math.floor(Math.random() * 10) + 2;
                op = Math.random() > 0.5 ? '+' : '-';
        }

        if (op === '+') ans = n1 + n2;
        if (op === '-') ans = n1 - n2;
        if (op === 'Ã—') ans = n1 * n2;

        // ×™×¦×™×¨×ª ××¡×™×—×™×
        let answers = new Set([ans]);
        while(answers.size < 4) {
            let fake = ans + Math.floor(Math.random() * 10) - 5;
            if(fake >= 0 && fake !== ans) answers.add(fake);
        }

        return {
            txt: `${n1} ${op} ${n2} = ?`,
            correct: ans,
            options: Array.from(answers).sort(() => Math.random() - 0.5)
        };
    }
};

/**
 * --- ×œ×•×’×™×§×ª ××©×—×§ ×¨××©×™×ª ---
 */
const game = {
    state: {
        level: 1,
        coins: 0,
        character: 'lia', // ×‘×¨×™×¨×ª ××—×“×œ ×œ×œ×™×”
        inventory: ['lia', 'pirate_capt'] // ×©× ×™×”× ×—×™× ×
    },
    
    currentProblem: null,

    init: () => {
        game.loadProgress();
        game.renderMap();
        game.updateHUD();
        game.placePlayer();
        
        // ×•×•×“× ×©×œ×™×” ×‘×‘×¢×œ×•×ª (×ª×™×§×•×Ÿ ×œ××§×¨×” ×©×œ ×©××™×¨×” ×™×©× ×”)
        const lia = CHARACTERS.find(c => c.id === 'lia');
        if (lia && !game.state.inventory.includes('lia')) {
            game.state.inventory.push('lia');
        }
    },

    loadProgress: () => {
        const saved = localStorage.getItem('mysteryIsland_v2');
        if (saved) {
            game.state = JSON.parse(saved);
        }
    },

    saveProgress: () => {
        localStorage.setItem('mysteryIsland_v2', JSON.stringify(game.state));
    },

    updateHUD: () => {
        document.getElementById('level-display').innerText = `ğŸï¸ ×©×œ×‘: ${game.state.level}`;
        document.getElementById('coins-display').innerText = `ğŸ’° ${game.state.coins}`;
        
        // ×¢×“×›×•×Ÿ ×ª××•× ×ª ×”×©×—×§×Ÿ
        const charObj = CHARACTERS.find(c => c.id === game.state.character);
        document.getElementById('player-img').src = charObj ? charObj.src : 'lia_p.jpg';
    },

    renderMap: () => {
        const container = document.getElementById('islands-container');
        const svgPath = document.getElementById('path-curve');
        container.innerHTML = '';
        
        let pathD = "M 50 20"; // × ×§×•×“×ª ×”×ª×—×œ×”
        const xCenter = window.innerWidth / 2;
        
        LEVELS.forEach((lvl, i) => {
            const island = document.createElement('div');
            island.className = `island ${lvl.id <= game.state.level ? '' : 'locked'} ${lvl.id < game.state.level ? 'completed' : ''} ${lvl.id === game.state.level ? 'current' : ''}`;
            
            // ××™×§×•× ××¤×•×ª×œ
            const y = 80 + (i * 120);
            const offset = Math.sin(i) * 30; // ×–×™×’×–×’
            const leftPos = 50 + offset; 
            
            island.style.top = `${y}px`;
            island.style.left = `${leftPos}%`;
            island.style.transform = `translate(-50%, 0)`;
            
            island.innerHTML = `<div class="island-num">${lvl.id}</div><div class="island-stars">${lvl.id < game.state.level ? 'â­â­â­' : ''}</div>`;
            
            island.onclick = () => {
                if(lvl.id === game.state.level) game.startLevel(lvl.id);
            };

            container.appendChild(island);

            // ×‘× ×™×™×ª ×”×©×‘×™×œ
            // ×—×™×©×•×‘ ×§×•××•×¨×“×™× ×˜×•×ª ×¤×©×•×˜ ×¢×‘×•×¨ ×”-SVG (×œ× ××“×•×™×§ ×‘-100% ××‘×œ ××¡×¤×™×§ ×•×™×–×•××œ×™×ª)
            // × ×©×ª××© ×‘×§×• ×™×©×¨ ×¤×©×•×˜ ×‘×™× ×ª×™×™× ×›×™ ×”×’×¨×™×“ ××•×¨×›×‘
        });

        // ×”×’×“×œ×ª ××–×•×¨ ×”××¤×”
        document.getElementById('map-area').querySelector('svg').style.height = `${LEVELS.length * 130}px`;
    },

    placePlayer: () => {
        const currentIsland = document.getElementsByClassName('island')[game.state.level - 1];
        if(currentIsland) {
            const marker = document.getElementById('player-marker');
            // ×—×™×©×•×‘ ××™×§×•× ×‘×™×—×¡ ×œ×’×œ×™×œ×”
            marker.style.top = currentIsland.style.top;
            marker.style.left = currentIsland.style.left;
            marker.style.transform = "translate(-50%, -20px)"; // ×§×¦×ª ××¢×œ ×”××™
            
            // ×’×œ×™×œ×” ××•×˜×•××˜×™×ª ×œ×©×—×§×Ÿ
            setTimeout(() => {
                currentIsland.scrollIntoView({behavior: 'smooth', block: 'center'});
            }, 500);
        }
    },

    openShop: () => {
        Sound.click();
        const grid = document.getElementById('shop-items');
        grid.innerHTML = '';
        
        CHARACTERS.forEach(char => {
            const isOwned = game.state.inventory.includes(char.id);
            const isSelected = game.state.character === char.id;
            
            const div = document.createElement('div');
            div.className = `shop-item ${isSelected ? 'selected' : ''}`;
            div.innerHTML = `
                <img src="${char.src}" onerror="this.src='https://via.placeholder.com/70?text=?'">
                <div style="font-weight:bold; font-size:0.9rem;">${char.name}</div>
                <div style="font-size:0.8rem;">${char.desc}</div>
                <button class="shop-btn" onclick="game.buyOrSelect('${char.id}', ${char.price})" ${!isOwned && game.state.coins < char.price ? 'disabled' : ''}>
                    ${isSelected ? '× ×‘×—×¨' : (isOwned ? '×‘×—×¨' : char.price + 'ğŸ’°')}
                </button>
            `;
            grid.appendChild(div);
        });

        document.getElementById('shop-modal').classList.add('active');
    },

    buyOrSelect: (charId, price) => {
        if (game.state.inventory.includes(charId)) {
            // ×‘×—×™×¨×”
            game.state.character = charId;
            Sound.click();
        } else {
            // ×§× ×™×™×”
            if (game.state.coins >= price) {
                game.state.coins -= price;
                game.state.inventory.push(charId);
                game.state.character = charId;
                Sound.win();
            }
        }
        game.saveProgress();
        game.updateHUD();
        game.openShop(); // ×¨×¢× ×•×Ÿ ×ª×¦×•×’×”
    },

    closeModal: (id) => {
        Sound.click();
        document.getElementById(id).classList.remove('active');
    },

    startLevel: (lvlId) => {
        Sound.click();
        game.currentProblem = MathGen.generate(lvlId);
        
        document.getElementById('math-problem-text').innerText = game.currentProblem.txt;
        const ansGrid = document.getElementById('math-answers');
        ansGrid.innerHTML = '';
        
        game.currentProblem.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'answer-btn';
            btn.innerText = opt;
            btn.onclick = () => game.checkAnswer(opt, lvlId);
            ansGrid.appendChild(btn);
        });
        
        document.getElementById('math-modal').classList.add('active');
    },

    checkAnswer: (val, lvlId) => {
        if (val === game.currentProblem.correct) {
            // ×ª×©×•×‘×” × ×›×•× ×”
            Sound.correct();
            game.showFeedback('âœ…', true);
            game.closeModal('math-modal');
            
            // ×ª×’××•×œ
            game.state.coins += 10;
            if (lvlId === game.state.level) {
                game.state.level++;
            }
            
            game.saveProgress();
            game.renderMap();
            game.updateHUD();
            setTimeout(game.placePlayer, 100);
            
        } else {
            // ×ª×©×•×‘×” ×©×’×•×™×”
            Sound.wrong();
            game.showFeedback('âŒ', false);
        }
    },

    showFeedback: (emoji, isGood) => {
        const el = document.getElementById('feedback');
        el.innerText = emoji;
        el.style.opacity = 1;
        el.style.color = isGood ? 'var(--success)' : 'var(--danger)';
        setTimeout(() => el.style.opacity = 0, 800);
    }
};

// ×”×ª×—×œ×ª ××©×—×§
window.onload = game.init;

</script>
</body>
</html>
